<p><span style="font-family: Courier;">原文链接：</span><a href="http://www.sencha.com/blog/2010/10/14/using-validations-and-associations-in-sencha-touch/"><span style="font-family: Courier;">http://www.sencha.com/blog/2010/10/14/using-validations-and-associations-in-sencha-touch/</span></a></p>
<p><span style="font-family: Courier;">October 14, 2010 by Ed Spencer</span></p>

<p><span style="line-height: 20px; color: #333333; font-family: Courier;">Sencha Touch&nbsp;</span><span style="font-family: Courier;">已经有了丰富的模型层，它可以方便地处理不同类型的数据。</span><span style="line-height: 20px; color: #333333; font-family: Courier;">自&nbsp;<a style="color: #0464bb; text-decoration: underline;" href="http://www.sencha.com/products/touch/"><span style="font-family: Courier;">Sencha Touch 0.97β</span></a>&nbsp;</span><span style="line-height: 20px; color: #333333; font-family: Courier;">起，模型支持验证它们的数据和关联其他模型变的非常丰</span><span style="line-height: 20px; color: #333333; font-family: Courier;">富。</span><span style="font-family: Courier;">这些新的特性使其更易于编写的</span><span style="font-family: Courier;">客户端应用程序</span><span style="font-family: Courier;">代码量减少了。</span></p>
<div style="padding: 0px; margin: 0px;" class="entry">
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; padding: 0px;"><span style="color: #333333; font-family: Courier;" face="Courier" color="#333333"><span style="line-height: 20px; font-family: Courier;">首先亮相，让我们来看看在模型中</span></span><span style="line-height: 20px; color: #333333; font-family: Courier;">使用</span><span style="color: #333333; font-family: Courier;" face="Courier" color="#333333"><span style="line-height: 20px; font-family: Courier;">验证。</span></span><span>本例中，我们将使用电子商务管理应用程序，其中的用户和产品模型。让我们首先定义产品模型：</span></p>
<div style="color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;" class="wp_syntax">
<div style="padding: 0px; margin: 0px;" class="code">
<pre class="javascript"><span style="font-family: Courier;">Ext.</span><span style="color: #660066; font-family: Courier;">ns</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #3366cc; font-family: Courier;">'MyApp'</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span><span style="font-family: Courier;">
&nbsp;
MyApp.</span><span style="color: #660066; font-family: Courier;">Product</span> <span style="color: #339933; font-family: Courier;">=</span><span style="font-family: Courier;"> Ext.</span><span style="color: #660066; font-family: Courier;">regModel</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #3366cc; font-family: Courier;">'Product'</span><span style="color: #339933; font-family: Courier;">,</span> <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">
    fields</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #009900; font-family: Courier;">[</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'id'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">      type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'int'</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #339933; font-family: Courier;">,</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'user_id'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;"> type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'int'</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #339933; font-family: Courier;">,</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'name'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">    type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'string'</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #339933; font-family: Courier;">,</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'price'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">   type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'float'</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #339933; font-family: Courier;">,</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'sku'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">     type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'string'</span><span style="color: #009900; font-family: Courier;">}</span>
    <span style="color: #009900; font-family: Courier;">]</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">
&nbsp;
    validations</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #009900; font-family: Courier;">[</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'presence'</span><span style="color: #339933; font-family: Courier;">,</span> <span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'name'</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #339933; font-family: Courier;">,</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'format'</span><span style="color: #339933; font-family: Courier;">,</span>   <span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'sku'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;"> matcher</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #339933; font-family: Courier;">/</span><span style="color: #009900; font-family: Courier;">[</span><span style="color: #cc0000; font-family: Courier;">0</span><span style="color: #339933; font-family: Courier;">-</span><span style="color: #cc0000; font-family: Courier;">9</span><span style="color: #009900; font-family: Courier;">]</span><span style="color: #009900; font-family: Courier;">{</span><span style="color: #cc0000; font-family: Courier;">4</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #009900; font-family: Courier;">[</span><span style="font-family: Courier;">A</span><span style="color: #339933; font-family: Courier;">-</span><span style="font-family: Courier;">Z</span><span style="color: #009900; font-family: Courier;">]</span><span style="color: #339933; font-family: Courier;">+/</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #339933; font-family: Courier;">,</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'length'</span><span style="color: #339933; font-family: Courier;">,</span>   <span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'name'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;"> min</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #cc0000; font-family: Courier;">3</span><span style="color: #009900; font-family: Courier;">}</span>
    <span style="color: #009900; font-family: Courier;">]</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">
&nbsp;
    proxy</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">
        type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'localstorage'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">
        id  </span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'products'</span>
    <span style="color: #009900; font-family: Courier;">}</span>
<span style="color: #009900; font-family: Courier;">}</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span></pre>
</div>
</div>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px; font-size: 14px;"><span style="font-family: Courier;">上面的模型定义大部分是不需要说明的：我们定义了一个叫做 Product 有 4 个字段的模型 – id，name，price 和 sku，加上了这些字段的几个验证规则。这些字段定义一直在&nbsp;</span><span style="font-family: Courier;">Sencha Touch&nbsp;</span><span style="font-family: Courier;">验证遵循相同的格式。在所有情况下</span><span style="color: #000000; font-family: Courier; line-height: 21px;">，我们指定字段和验证的类型。有些验证采取额外的</span><span style="color: #000000; font-family: Courier; line-height: 21px;">可选配置</span><span style="color: #000000; font-family: Courier; line-height: 21px;"> – 例如长度验证可以采取最小和最大属性，格式可用匹配器，等等。</span></span></p>
<p><span style="font-family: Courier;">Sencha&nbsp;内建&nbsp;5 种验证方式并且很容易添加定制规则。 首先，让我们, 让我们认识内建的:</span></p>
<dl style="margin-top: 0px; margin-right: 0px; margin-bottom: 1em; margin-left: 0px; padding: 0px;"><dt style="font-weight: bold !important; color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;"><strong style="font-weight: bold; font-family: Courier;">presence</strong></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 24px; padding: 0px;"><span style="color: #555555; font-family: Courier;" face="Courier" color="#555555"><span style="line-height: 20px;">只是确定该字段有一个值。</span></span><span style="font-family: Courier; line-height: 20px; color: #555555;">0 是有效的值但空字符串不是。</span></dd><dt style="font-weight: bold !important; color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;"><strong style="font-weight: bold; font-family: Courier;">长度</strong></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 24px; padding: 0px;"><span style="color: #555555; font-family: Courier;" face="Courier" color="#555555"><span style="line-height: 20px;">确保一个字符串之间的最小和最大长度。这两个约束是可选的。</span></span></dd><dt style="font-weight: bold !important; color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;"><strong style="font-weight: bold; font-family: Courier;">格式</strong></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 24px; color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">确定一个字符串匹配一个正则表达式的格式。在上面的例子我们确保SKU 4个数字后面至少跟着一个字母。</span></dd><dt style="font-weight: bold !important; color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;"><strong style="font-weight: bold; font-family: Courier;">包含</strong></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 24px; color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">确保一个值在一组特定的值里 (e.g. 确保性别是男性或女性)。</span></dd><dt style="font-weight: bold !important; color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;"><strong style="font-weight: bold; font-family: Courier;">排除</strong></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 24px; color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">确保一个值不在一组特定的值里 (e.g. 用户名黑名单，比如‘admin’)。</span></dd></dl>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">现在我们有把握做不同的验证，让我们试着对一个产品实例用它们。我们将创建产品实例并且针对它运行验证，注意任何失败：</span></p>
<div style="color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;" class="wp_syntax">
<div style="padding: 0px; margin: 0px;" class="code">
<pre class="javascript"><span style="color: #003366; font-weight: bold; font-family: Courier;">var</span><span style="font-family: Courier;"> product </span><span style="color: #339933; font-family: Courier;">=</span> <span style="color: #003366; font-weight: bold; font-family: Courier;">new</span><span style="font-family: Courier;"> MyApp.</span><span style="color: #660066; font-family: Courier;">Product</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">{</span>
    <span style="color: #000066; font-family: Courier;">name</span> <span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'Sencha Touch'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">
    sku  </span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'not a valid sku'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">
    price</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #cc0000; font-family: Courier;">99</span>
<span style="color: #009900; font-family: Courier;">}</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span>
&nbsp;
<span style="color: #003366; font-weight: bold; font-family: Courier;">var</span><span style="font-family: Courier;"> errors </span><span style="color: #339933; font-family: Courier;">=</span><span style="font-family: Courier;"> product.</span><span style="color: #660066; font-family: Courier;">validate</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span><span style="font-family: Courier;">
&nbsp;
errors.</span><span style="color: #660066; font-family: Courier;">isValid</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #009900; font-family: Courier;">)</span> <span style="color: #006600; font-style: italic; font-family: Courier;">//returns 'false' as there were validation errors</span><span style="font-family: Courier;">
errors.</span><span style="color: #660066; font-family: Courier;">items</span><span style="color: #339933; font-family: Courier;">;</span> <span style="color: #006600; font-style: italic; font-family: Courier;">//returns the array of all errors found on this model instance</span><span style="font-family: Courier;">
&nbsp;
errors.</span><span style="color: #660066; font-family: Courier;">forField</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #3366cc; font-family: Courier;">'sku'</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span> <span style="color: #006600; font-style: italic; font-family: Courier;">//returns the errors for the sku field</span></pre>
</div>
</div>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">这里的主要函数是 validate(), 运行所有配置的验证并且返回一个 Ext.data.Errors 对象。这个简单的对象仅仅是一个发现的任何错误的集合，再加上一些方便的方法例如 isValid() – 如果所有的字段均没有错将返回 true – 还有 forField(), 它返回给定字段的所有错误。</span></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">在我们的电子商务系统每一个产品都是有用户创建，因此现在我们建立用户模型：</span></p>
<div style="color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;" class="wp_syntax">
<div style="padding: 0px; margin: 0px;" class="code">
<pre class="javascript"><span style="font-family: Courier;">MyApp.</span><span style="color: #660066; font-family: Courier;">User</span> <span style="color: #339933; font-family: Courier;">=</span><span style="font-family: Courier;"> Ext.</span><span style="color: #660066; font-family: Courier;">regModel</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #3366cc; font-family: Courier;">'User'</span><span style="color: #339933; font-family: Courier;">,</span> <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">
    fields</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #009900; font-family: Courier;">[</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'id'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">       type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'int'</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #339933; font-family: Courier;">,</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'name'</span><span style="color: #339933; font-family: Courier;">,</span><span id="aeaoofnhgocdbnbeljkmbjdmhbcokfdb-mousedown" style="font-family: Courier;">     type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'string'</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #339933; font-family: Courier;">,</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'gender'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">   type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'string'</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #339933; font-family: Courier;">,</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'username'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;"> type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'string'</span><span style="color: #009900; font-family: Courier;">}</span>
    <span style="color: #009900; font-family: Courier;">]</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">
&nbsp;
    validations</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #009900; font-family: Courier;">[</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'inclusion'</span><span style="color: #339933; font-family: Courier;">,</span> <span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'gender'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">   list</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #009900; font-family: Courier;">[</span><span style="color: #3366cc; font-family: Courier;">'male'</span><span style="color: #339933; font-family: Courier;">,</span> <span style="color: #3366cc; font-family: Courier;">'female'</span><span style="color: #009900; font-family: Courier;">]</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #339933; font-family: Courier;">,</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'exclusion'</span><span style="color: #339933; font-family: Courier;">,</span> <span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'username'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;"> list</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #009900; font-family: Courier;">[</span><span style="color: #3366cc; font-family: Courier;">'admin'</span><span style="color: #009900; font-family: Courier;">]</span><span style="color: #009900; font-family: Courier;">}</span>
    <span style="color: #009900; font-family: Courier;">]</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">
&nbsp;
    associations</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #009900; font-family: Courier;">[</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'hasMany'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;"> model</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'Product'</span><span style="color: #339933; font-family: Courier;">,</span> <span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'products'</span><span style="color: #009900; font-family: Courier;">}</span>
    <span style="color: #009900; font-family: Courier;">]</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">
&nbsp;
    proxy</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">
        type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'localstorage'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">
        id  </span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'users'</span>
    <span style="color: #009900; font-family: Courier;">}</span>
<span style="color: #009900; font-family: Courier;">}</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span></pre>
</div>
</div>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">定义用户遵循我们定义产品相同的模式 – 我们建立字段和一些验证。在这种情况下，我们验证性别字段是不是男性或女性，并且用户名可以是除了‘admin’的任何名字。</span></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">不过这次，我们还为这个模型加入了关联。有Sencha Touch 里有 2 种主要的关联类型 – hasMany 和 belongsTo。在我们的应用里每一个用户创建许多产品，因此我们位</span><span style="font-family: Courier;">User 到 Product&nbsp;</span><span style="font-family: Courier;">创建 hasMany 关联。</span></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">关联给我们一个强有力的手段去操纵相关的数据。例如：加载一个特定用户的所有产品是非常简单：</span></p>
<div style="color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;" class="wp_syntax">
<div style="padding: 0px; margin: 0px;" class="code">
<pre class="javascript"><span style="color: #003366; font-weight: bold; font-family: Courier;">var</span><span style="font-family: Courier;"> user </span><span style="color: #339933; font-family: Courier;">=</span> <span style="color: #003366; font-weight: bold; font-family: Courier;">new</span><span style="font-family: Courier;"> MyApp.</span><span style="color: #660066; font-family: Courier;">User</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">id</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #cc0000; font-family: Courier;">10</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span>
&nbsp;
<span style="color: #006600; font-style: italic; font-family: Courier;">//loads all products where user_id = 10</span><span style="font-family: Courier;">
user.</span><span style="color: #660066; font-family: Courier;">products</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">)</span><span style="font-family: Courier;">.</span><span style="color: #660066; font-family: Courier;">load</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">
    callback</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #003366; font-weight: bold; font-family: Courier;">function</span><span style="color: #009900; font-family: Courier;">(</span><span style="font-family: Courier;">records</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;"> operation</span><span style="color: #009900; font-family: Courier;">)</span> <span style="color: #009900; font-family: Courier;">{</span>
        <span style="color: #000066; font-family: Courier;">alert</span><span style="color: #009900; font-family: Courier;">(</span><span style="font-family: Courier;">records.</span><span style="color: #660066; font-family: Courier;">length</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span>
    <span style="color: #009900; font-family: Courier;">}</span>
<span style="color: #009900; font-family: Courier;">}</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span></pre>
</div>
</div>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;"><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">让我们分析一下上面这个代码实际上做的事情。</span></span><span style="font-family: Courier;">我们定义的关联在用户对象创建了一个叫做 products() 的新方法。此方法返回一个 Ext.data.Store 它只从加载的产品过滤当user_id 等于 User 实例 id (在这个事例中是10)。</span></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">因为我们在浏览器中并且访问数据库有很长的时间，所有的载入和保存操作都是异步的，因此我们必须传递一个回调函数来生成 Products 存储的 load 方法。This callback is given the records that are loaded as well as the Ext.data.Operation object that is used to load them.</span></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">关联不仅仅有助于装载数据 – 它们创建新的记录也非常有用：</span></p>
<div style="color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;" class="wp_syntax">
<div style="padding: 0px; margin: 0px;" class="code">
<pre class="javascript"><span style="font-family: Courier;">user.</span><span style="color: #660066; font-family: Courier;">products</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">)</span><span style="font-family: Courier;">.</span><span style="color: #660066; font-family: Courier;">add</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">{</span>
    <span style="color: #000066; font-family: Courier;">name</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'Ext JS 4.0'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;">
    sku </span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'1234A'</span>
<span style="color: #009900; font-family: Courier;">}</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span><span style="font-family: Courier;">
&nbsp;
user.</span><span style="color: #660066; font-family: Courier;">products</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">)</span><span style="font-family: Courier;">.</span><span style="color: #660066; font-family: Courier;">sync</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span></pre>
</div>
</div>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">这里我们实例化一个新的产品，它会自动给出在user_id字段的用户id。调用 sync() 通过它配置的代理保存这个新的产品 –&nbsp;</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">这又是一个异步操作，</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">如果你想要操作完成时</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">得到通知</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">，</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">你可以传递一个回调。</span></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;"><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">它通常是非常有用的</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">双方</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">关系都了解关联，让我们更新我们的产品模型定义：</span></span><span style="font-family: Courier;">It’s usually useful to have both sides of a relationship know about the association</span></p>
<div style="color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;" class="wp_syntax">
<div style="padding: 0px; margin: 0px;" class="code">
<pre class="javascript"><span style="font-family: Courier;">MyApp.</span><span style="color: #660066; font-family: Courier;">Product</span> <span style="color: #339933; font-family: Courier;">=</span><span style="font-family: Courier;"> Ext.</span><span style="color: #660066; font-family: Courier;">regModel</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #3366cc; font-family: Courier;">'Product'</span><span style="color: #339933; font-family: Courier;">,</span> <span style="color: #009900; font-family: Courier;">{</span>
    <span style="color: #006600; font-style: italic; font-family: Courier;">//same fields and validations as before</span><span style="font-family: Courier;">
    ...
&nbsp;
    </span><span style="color: #660066; font-family: Courier;">associations</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #009900; font-family: Courier;">[</span>
        <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">type</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'belongsTo'</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;"> model</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #3366cc; font-family: Courier;">'User'</span><span style="color: #009900; font-family: Courier;">}</span>
    <span style="color: #009900; font-family: Courier;">]</span>
<span style="color: #009900; font-family: Courier;">}</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span></pre>
</div>
</div>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">belongsTo 关联同样可以在模型里建立新的方法，下面是我们怎么使用这些：</span></p>
<div style="color: #555555; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px; margin: 0px;" class="wp_syntax">
<div style="padding: 0px; margin: 0px;" class="code">
<pre class="javascript"><span style="color: #003366; font-weight: bold; font-family: Courier;">var</span><span style="font-family: Courier;"> product </span><span style="color: #339933; font-family: Courier;">=</span> <span style="color: #003366; font-weight: bold; font-family: Courier;">new</span><span style="font-family: Courier;"> MyApp.</span><span style="color: #660066; font-family: Courier;">Product</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">id</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #cc0000; font-family: Courier;">100</span><span style="color: #009900; font-family: Courier;">}</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span><span style="font-family: Courier;">
&nbsp;
product.</span><span style="color: #660066; font-family: Courier;">getUser</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #003366; font-weight: bold; font-family: Courier;">function</span><span style="color: #009900; font-family: Courier;">(</span><span style="font-family: Courier;">user</span><span style="color: #009900; font-family: Courier;">)</span> <span style="color: #009900; font-family: Courier;">{</span>
    <span style="color: #006600; font-style: italic; font-family: Courier;">//do something with the loaded user model</span>
<span style="color: #009900; font-family: Courier;">}</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span><span style="font-family: Courier;">
&nbsp;
product.</span><span style="color: #660066; font-family: Courier;">setUser</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #cc0000; font-family: Courier;">100</span><span style="color: #339933; font-family: Courier;">,</span> <span style="color: #009900; font-family: Courier;">{</span><span style="font-family: Courier;">
    callback</span><span style="color: #339933; font-family: Courier;">:</span> <span style="color: #003366; font-weight: bold; font-family: Courier;">function</span><span style="color: #009900; font-family: Courier;">(</span><span style="font-family: Courier;">product</span><span style="color: #339933; font-family: Courier;">,</span><span style="font-family: Courier;"> operation</span><span style="color: #009900; font-family: Courier;">)</span> <span style="color: #009900; font-family: Courier;">{</span>
        <span style="color: #000066; font-weight: bold; font-family: Courier;">if</span> <span style="color: #009900; font-family: Courier;">(</span><span style="font-family: Courier;">operation.</span><span style="color: #660066; font-family: Courier;">wasSuccessful</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #009900; font-family: Courier;">)</span> <span style="color: #009900; font-family: Courier;">{</span>
            <span style="color: #000066; font-family: Courier;">alert</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #3366cc; font-family: Courier;">'Product user updated'</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span>
        <span style="color: #009900; font-family: Courier;">}</span> <span style="color: #000066; font-weight: bold; font-family: Courier;">else</span> <span style="color: #009900; font-family: Courier;">{</span>
            <span style="color: #000066; font-family: Courier;">alert</span><span style="color: #009900; font-family: Courier;">(</span><span style="color: #3366cc; font-family: Courier;">'Product user could not be updated'</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span>
        <span style="color: #009900; font-family: Courier;">}</span>
    <span style="color: #009900; font-family: Courier;">}</span>
<span style="color: #009900; font-family: Courier;">}</span><span style="color: #009900; font-family: Courier;">)</span><span style="color: #339933; font-family: Courier;">;</span></pre>
</div>
</div>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;">再一次，加载方法 (getUser) 是异步的并且需要一个回调函数给用户给用户实例。</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">setUser方法简单地更新foreign_key（在这种情况下的user_id）到100并保存产品型号。。</span><span style="font-family: Courier;">&nbsp;</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">像往常一样，可以在保存操作</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">完成</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">时触发</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">回调将&nbsp;</span><span style="font-family: Courier;">– 无论成功与否。</span></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-size: 12px; line-height: 20px; padding: 0px;"><span style="font-family: Courier;" face="Courier"><span style="color: #000000; line-height: 21px; font-size: 14px;">&nbsp;</span></span></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 12px; margin-left: 0px; color: #333333; font-size: 12px; line-height: 20px; font-family: Helvetica, Arial, Verdana, Geneva, sans-serif; padding: 0px;"><span style="font-family: Courier;"><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">了解验证和关联</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">最好的方法是查看</span>&nbsp;</span><a style="color: #0464bb; text-decoration: underline;" href="http://dev.sencha.com/deploy/touch/docs/?class=Ext.data.Model"><span style="font-family: Courier;">check out the updated Model documentation</span></a><span style="font-family: Courier;">， 同样还有&nbsp;</span><a style="color: #0464bb; text-decoration: underline;" href="http://dev.sencha.com/deploy/touch/docs/?class=Ext.data.HasManyAssociation"><span style="font-family: Courier;">docs on the hasMany</span></a><span style="font-family: Courier;">&nbsp;和&nbsp;</span><a style="color: #0464bb; text-decoration: underline;" href="http://dev.sencha.com/deploy/touch/docs/?class=Ext.data.BelongsToAssociation"><span style="font-family: Courier;">belongsTo associations</span></a><span style="font-family: Courier;">。&nbsp;</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">最后，要知道，因为我们仍处于测试阶段，这个新的API功能在版本1.0之前</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">可能会略有变化</span><span style="color: #000000; font-family: verdana, 'courier new'; line-height: 21px;">。</span></p>
</div>
<p><span style="font-family: Courier;" face="Courier"><span style="line-height: 18px;"><br /></span></span></p>]]